import React from "react"


import { useState, useEffect } from "react"
import { Box, Alert } from "@mui/material"
// import { getParkingSessions, exportSessionsToCSV } from "../../api/parkingSessionApi"
import { calculateDuration } from "../../utils/formatters.js"
import ParkingSessionFilters from "./components/ParkingSessionFilter.jsx"
import ParkingSessionTable from "./components/ParkingSessionTable.jsx"
import {getRequest} from "../../api/index.js";

const ParkingSessions = () => {
    // State for sessions data
    const [sessions, setSessions] = useState([])
    const [filteredSessions, setFilteredSessions] = useState([])
    const [loading, setLoading] = useState(true)
    const [error, setError] = useState(null)

    // State for search and filters
    const [searchQuery, setSearchQuery] = useState("")
    const [statusFilter, setStatusFilter] = useState("all")
    const [paymentFilter, setPaymentFilter] = useState("all")

    // State for sorting
    const [sortConfig, setSortConfig] = useState({
        field: "entry_time",
        direction: "desc",
    })


    // Fetch sessions on component mount
    useEffect(() => {
        loadParkingSessions()
    }, [])

    // Apply filters, sorting when dependencies change
    useEffect(() => {
        applyFiltersAndSort()
    }, [sessions, searchQuery, statusFilter, paymentFilter, sortConfig])

    const loadParkingSessions = async () => {
        setLoading(true)
        setError(null)

        try {
            const response = await getRequest("/session");
            if (response.code === 200) {
                setSessions(response.info)
            } else {
                throw new Error(response.message || "Failed to fetch parking sessions")
            }
        } catch (err) {
            console.error("Error loading parking sessions:", err)
            setError("Failed to load parking sessions. Please try again.")
        } finally {
            setLoading(false)
        }
    }

    // Apply filters and sorting
    const applyFiltersAndSort = () => {
        let result = [...sessions]

        // Apply search filter
        if (searchQuery) {
            const query = searchQuery.toLowerCase()
            result = result.filter(
                (session) =>
                    session.Vehicle.vehicle_number.toLowerCase().includes(query) || session.session_id.toString().includes(query),
            )
        }

        // Apply status filter
        if (statusFilter !== "all") {
            result = result.filter((session) => session.status === statusFilter)
        }

        // Apply payment filter
        if (paymentFilter !== "all") {
            result = result.filter((session) => session.payment_status === paymentFilter)
        }

        // Apply sorting
        result.sort((a, b) => {
            let valueA, valueB

            // Handle different field types
            switch (sortConfig.field) {
                case "fee":
                    valueA = a.fee ? Number.parseFloat(a.fee) : 0
                    valueB = b.fee ? Number.parseFloat(b.fee) : 0
                    break
                case "duration":
                    valueA = calculateDuration(a)
                    valueB = calculateDuration(b)
                    break
                default:
                    valueA = a[sortConfig.field]
                    valueB = b[sortConfig.field]
            }

            // Handle null values
            if (valueA === null) return sortConfig.direction === "asc" ? -1 : 1
            if (valueB === null) return sortConfig.direction === "asc" ? 1 : -1

            // Compare values
            if (valueA < valueB) return sortConfig.direction === "asc" ? -1 : 1
            if (valueA > valueB) return sortConfig.direction === "asc" ? 1 : -1
            return 0
        })

        setFilteredSessions(result)
    }



    // Handle sort change
    const handleSort = (field) => {
        setSortConfig((prevConfig) => ({
            field,
            direction: prevConfig.field === field && prevConfig.direction === "desc" ? "asc" : "desc",
        }))
    }



    return (
        <Box>
            {/*/!* Header *!/*/}
            {/*<Box sx={{ mb: 4 }}>*/}
            {/*    <Typography variant="h4" component="h1" gutterBottom>*/}
            {/*        Parking Sessions*/}
            {/*    </Typography>*/}
            {/*    <Typography variant="body1" color="text.secondary">*/}
            {/*        View and manage parking sessions*/}
            {/*    </Typography>*/}
            {/*</Box>*/}


            {/* Filters and Actions */}
            <ParkingSessionFilters
                searchQuery={searchQuery}
                setSearchQuery={setSearchQuery}
                statusFilter={statusFilter}
                setStatusFilter={setStatusFilter}
                paymentFilter={paymentFilter}
                setPaymentFilter={setPaymentFilter}
                onRefresh={loadParkingSessions}
                loading={loading}
                hasData={filteredSessions.length > 0}
            />

            {/* Error message */}
            {error && (
                <Alert severity="error" sx={{ mb: 3 }}>
                    {error}
                </Alert>
            )}

            {/* Sessions Table */}
            <ParkingSessionTable sessions={filteredSessions} loading={loading} sortConfig={sortConfig} onSort={handleSort} />
        </Box>
    )
}

export default ParkingSessions
